input {
  # Receive logs from Filebeat
  beats {
    port => 5044
  }
}

filter {
  # Parse application logs (JSON format from Winston)
  if [log_type] == "application" {
    # Logs are already in JSON format from Winston
    
    # Add useful metadata
    mutate {
      add_field => {
        "[@metadata][index]" => "ollama-app-logs"
      }
    }
    
    # Convert duration_ms to number if present
    if [duration_ms] {
      mutate {
        convert => { "duration_ms" => "float" }
      }
    }
    
    # Convert status_code to number if present
    if [status_code] {
      mutate {
        convert => { "status_code" => "integer" }
      }
    }
  }
  
  # Parse nginx access logs
  if [log_type] == "nginx-access" {
    grok {
      match => {
        "message" => '%{IPORHOST:remote_addr} - %{DATA:remote_user} \[%{HTTPDATE:time_local}\] "%{WORD:method} %{DATA:request} HTTP/%{NUMBER:http_version}" %{NUMBER:status} %{NUMBER:body_bytes_sent} "%{DATA:http_referer}" "%{DATA:http_user_agent}"'
      }
    }
    
    date {
      match => ["time_local", "dd/MMM/yyyy:HH:mm:ss Z"]
      target => "@timestamp"
    }
    
    mutate {
      add_field => {
        "[@metadata][index]" => "ollama-nginx-access"
      }
      convert => {
        "status" => "integer"
        "body_bytes_sent" => "integer"
      }
    }
    
    # Extract endpoint from request
    grok {
      match => { "request" => "%{URIPATH:endpoint}" }
    }
  }
  
  # Parse nginx error logs
  if [log_type] == "nginx-error" {
    grok {
      match => {
        "message" => '%{DATA:time} \[%{DATA:severity}\] %{NUMBER:pid}#%{NUMBER:tid}: \*%{NUMBER:connection_id} %{GREEDYDATA:error_message}'
      }
    }
    
    mutate {
      add_field => {
        "[@metadata][index]" => "ollama-nginx-error"
      }
    }
  }
  
  # Parse Docker container logs
  if [container] {
    # Add container metadata to index name
    if [container][name] =~ /backend/ {
      mutate {
        add_field => {
          "[@metadata][index]" => "ollama-backend-container"
          "backend_instance" => "%{[container][name]}"
        }
      }
    }
  }
  
  # Remove unnecessary fields to reduce storage
  mutate {
    remove_field => ["agent", "ecs", "input", "host.name"]
  }
}

output {
  # Output to Elasticsearch with dynamic index names
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "%{[@metadata][index]}-%{+YYYY.MM.dd}"
    document_type => "_doc"
  }
  
  # Debug output to stdout (can be disabled in production)
  # stdout {
  #   codec => rubydebug
  # }
}